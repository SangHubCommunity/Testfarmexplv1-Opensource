-- [1] Anti-AFK
for i, v in pairs(getconnections(game.Players.LocalPlayer.Idled)) do
    v:Disable()
end

-- [2] GUI Setup
local player = game.Players.LocalPlayer
local vim = game:GetService("VirtualInputManager")
local coreGui = game:GetService("CoreGui")

getgenv().AutoFarm = false
getgenv().UseMelee = true

local gui = Instance.new("ScreenGui", coreGui)
gui.Name = "SangHub"
gui.ResetOnSpawn = false

-- [3] Toggle GUI Button
local toggleBtn = Instance.new("TextButton", gui)
toggleBtn.Size = UDim2.new(0, 100, 0, 30)
toggleBtn.Position = UDim2.new(0, 10, 0, 0.05)
toggleBtn.Text = "Toggle GUI"
toggleBtn.BackgroundColor3 = Color3.fromRGB(30, 200, 30)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 14
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 8)

-- [4] Main GUI Frame
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 350, 0, 600)
frame.Position = UDim2.new(0.05, 0, 0.15, 0)
frame.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
frame.Visible = true
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

-- [5] Tab Title
local tabTitle = Instance.new("TextLabel", frame)
tabTitle.Size = UDim2.new(1, 0, 0, 35)
tabTitle.Position = UDim2.new(0, 0, 0, 0)
tabTitle.BackgroundTransparency = 1
tabTitle.Text = "Main - Auto Farm"
tabTitle.Font = Enum.Font.GothamBold
tabTitle.TextColor3 = Color3.fromRGB(0, 255, 0)
tabTitle.TextSize = 18

-- [6] Button Template
local function createButton(text, posY, callback)
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.new(0, 300, 0, 40)
    btn.Position = UDim2.new(0, 25, 0, posY)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    btn.MouseButton1Click:Connect(callback)
    return btn
end

-- [7] Auto Farm Toggle Button
local autoFarmBtn = createButton("Auto Farm: OFF", 50, function()
    getgenv().AutoFarm = not getgenv().AutoFarm
    autoFarmBtn.Text = getgenv().AutoFarm and "Auto Farm: ON" or "Auto Farm: OFF"
end)

-- [8] Select Weapon Toggle
local weaponBtn = createButton("Weapon: Melee 🥋", 100, function()
    getgenv().UseMelee = not getgenv().UseMelee
    weaponBtn.Text = getgenv().UseMelee and "Weapon: Melee 🥋" or "Weapon: Sword ⚔️"
end)

-- [9] Toggle GUI visibility
toggleBtn.MouseButton1Click:Connect(function()
    frame.Visible = not frame.Visible
end)

-- [10] Auto Attack Loop
task.spawn(function()
    while task.wait(0.15) do
        if getgenv().AutoFarm then
            vim:SendMouseButtonEvent(0, 0, 0, true, game, 0)
            task.wait()
            vim:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        end
    end
end)
-- Phần 10: Auto Equip Weapon
function AutoEquipWeapon()
    local weaponList = {
        "Combat", "Black Leg", "Electro", "Fishman Karate", "Dragon Claw", "Superhuman",
        "Sharkman Karate", "Electric Claw", "Death Step", "Dragon Breath", "Godhuman",
        "Dark Blade", "Yama", "Tushita", "Hallow Scythe", "Cursed Dual Katana", "Shisui",
        "Wando", "Saddi", "Rengoku", "True Triple Katana", "Spikey Trident", "Buddy Sword",
        "Midnight Blade", "Canvander", "Pole", "Pole (2nd Form)", "Kabucha", "Serpent Bow"
    }

    for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
        if table.find(weaponList, v.Name) then
            game.Players.LocalPlayer.Character.Humanoid:EquipTool(v)
            break
        end
    end
end

-- Phần 11: Create Fake Platform
function CreatePlatform()
    local platform = Instance.new("Part")
    platform.Size = Vector3.new(10, 1, 10)
    platform.Anchored = true
    platform.Transparency = 1
    platform.Position = game.Players.LocalPlayer.Character.HumanoidRootPart.Position - Vector3.new(0, 3.5, 0)
    platform.Parent = workspace
    return platform
end

-- Phần 12: Increase Hitbox
function IncreaseHitbox()
    for _, v in pairs(workspace.Enemies:GetChildren()) do
        if v:FindFirstChild("HumanoidRootPart") then
            v.HumanoidRootPart.Size = Vector3.new(50, 50, 50)
            v.HumanoidRootPart.Transparency = 1
            v.HumanoidRootPart.CanCollide = false
        end
    end
end

-- Phần 13: Tween To Position
function TweenTo(pos)
    local char = game.Players.LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        local ts = game:GetService("TweenService")
        local ti = TweenInfo.new((char.HumanoidRootPart.Position - pos.Position).Magnitude / 250, Enum.EasingStyle.Linear)
        local tween = ts:Create(char.HumanoidRootPart, ti, {CFrame = pos})
        tween:Play()
        tween.Completed:Wait()
    end
end

-- Phần 14: Auto Attack
function AutoClick()
    local vim = game:GetService("VirtualInputManager")
    task.spawn(function()
        while getgenv().AutoFarm do
            vim:SendMouseButtonEvent(0, 0, 0, true, game, 0)
            task.wait()
            vim:SendMouseButtonEvent(0, 0, 0, false, game, 0)
            task.wait(0.1)
        end
    end)
end

-- Phần 15: Auto Quest
function AutoQuest(mobName, questName)
    local npc = workspace:FindFirstChild("NPCs"):FindFirstChild(questName)
    if npc then
        TweenTo(npc.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0))
        task.wait(1)
        game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("StartQuest", questName, 1)
    end
end

-- Phần 16: Level Mob Table
local LevelToMob = {
    {Level = 1, Mob = "Bandit", Quest = "BanditQuest1", LevelReq = 1},
    {Level = 15, Mob = "Monkey", Quest = "JungleQuest", LevelReq = 15},
    {Level = 20, Mob = "Gorilla", Quest = "JungleQuest", LevelReq = 20},
    {Level = 30, Mob = "Pirate", Quest = "BuggyQuest1", LevelReq = 30},
    {Level = 40, Mob = "Brute", Quest = "BuggyQuest1", LevelReq = 40},
    {Level = 60, Mob = "Desert Bandit", Quest = "DesertQuest", LevelReq = 60},
    {Level = 75, Mob = "Desert Officer", Quest = "DesertQuest", LevelReq = 75},
    {Level = 90, Mob = "Snow Bandit", Quest = "SnowQuest", LevelReq = 90},
    {Level = 105, Mob = "Snowman", Quest = "SnowQuest", LevelReq = 105}
    -- Thêm phần còn lại tương tự
}

-- Phần 17: Get Nearest Mob
function GetNearestMob(mobName)
    local closest, distance = nil, math.huge
    for _, mob in pairs(workspace.Enemies:GetChildren()) do
        if mob.Name == mobName and mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
            local dist = (mob.HumanoidRootPart.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            if dist < distance then
                closest = mob
                distance = dist
            end
        end
    end
    return closest
end

-- Phần 18: Auto Farm Logic
function StartAutoFarm()
    task.spawn(function()
        while getgenv().AutoFarm do
            local level = game.Players.LocalPlayer.Data.Level.Value
            local currentMob
            for i = #LevelToMob, 1, -1 do
                if level >= LevelToMob[i].LevelReq then
                    currentMob = LevelToMob[i]
                    break
                end
            end

            if currentMob then
                AutoQuest(currentMob.Mob, currentMob.Quest)
                local mob = GetNearestMob(currentMob.Mob)
                if mob then
                    local block = CreatePlatform()
                    TweenTo(mob.HumanoidRootPart.CFrame * CFrame.new(0, 20, 0))
                    IncreaseHitbox()
                    AutoEquipWeapon()
                    AutoClick()
                    repeat task.wait() until mob.Humanoid.Health <= 0 or not getgenv().AutoFarm
                    block:Destroy()
                end
            end
            task.wait(1)
        end
    end)
end

-- Phần 19: Toggle Button Example
getgenv().AutoFarm = false
local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0, 200, 0, 50)
btn.Position = UDim2.new(0.5, -100, 0.8, 0)
btn.Text = "Auto Farm: OFF"
btn.Parent = game.CoreGui
btn.MouseButton1Click:Connect(function()
    getgenv().AutoFarm = not getgenv().AutoFarm
    btn.Text = getgenv().AutoFarm and "Auto Farm: ON" or "Auto Farm: OFF"
    if getgenv().AutoFarm then
        StartAutoFarm()
    end
end)

-- Phần 20: ESP Setup
function ESPPlayer()
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local esp = Instance.new("BillboardGui", player.Character.HumanoidRootPart)
            esp.Size = UDim2.new(0, 100, 0, 40)
            esp.AlwaysOnTop = true
            local name = Instance.new("TextLabel", esp)
            name.Size = UDim2.new(1, 0, 1, 0)
            name.BackgroundTransparency = 1
            name.Text = player.Name
            name.TextColor3 = Color3.fromRGB(0, 255, 0)
            name.TextScaled = true
        end
    end
end
-- Phần 21: ESP Fruit
function ESPFruit()
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Tool") and string.find(obj.Name:lower(), "fruit") and not obj:FindFirstChild("ESP") then
            local esp = Instance.new("BillboardGui", obj)
            esp.Name = "ESP"
            esp.Size = UDim2.new(0, 100, 0, 40)
            esp.AlwaysOnTop = true
            local label = Instance.new("TextLabel", esp)
            label.Size = UDim2.new(1, 0, 1, 0)
            label.BackgroundTransparency = 1
            label.Text = obj.Name
            label.TextColor3 = Color3.fromRGB(255, 0, 0)
            label.TextScaled = true
        end
    end
end

-- Phần 22: ESP Island (Sea 1)
function ESPIsland()
    for name, pos in pairs(IslandPositions) do
        local part = Instance.new("Part", workspace)
        part.Anchored = true
        part.CanCollide = false
        part.Size = Vector3.new(1, 1, 1)
        part.Transparency = 1
        part.Position = pos.Position

        local gui = Instance.new("BillboardGui", part)
        gui.Size = UDim2.new(0, 100, 0, 40)
        gui.AlwaysOnTop = true
        local label = Instance.new("TextLabel", gui)
        label.Size = UDim2.new(1, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.TextColor3 = Color3.fromRGB(255, 255, 0)
        label.TextScaled = true
    end
end

-- Phần 23: Auto Collect Fruit
function AutoCollectFruit()
    task.spawn(function()
        while getgenv().AutoCollectFruit do
            for _, obj in pairs(workspace:GetDescendants()) do
                if obj:IsA("Tool") and string.find(obj.Name:lower(), "fruit") then
                    TweenTo(obj.Handle.CFrame)
                    task.wait(1)
                end
            end
            task.wait(5)
        end
    end)
end

-- Phần 24: Auto Store Fruit (Open Stock from anywhere)
function OpenFruitStock()
    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("GetFruits")
end

-- Phần 25: Auto Store Owned Fruit
function AutoStoreFruit()
    local fruitNames = {
        "Kilo-Kilo", "Spin-Spin", "Bomb-Bomb", "Spring-Spring", "Chop-Chop", "Rubber-Rubber",
        "Smoke-Smoke", "Flame-Flame", "Ice-Ice", "Sand-Sand", "Dark-Dark", "Revive-Revive",
        "Diamond-Diamond", "Light-Light", "Love-Love", "Magma-Magma", "Barrier-Barrier",
        "Quake-Quake", "Human-Human", "Buddha-Buddha", "String-String", "Phoenix-Phoenix",
        "Rumble-Rumble", "Paw-Paw", "Gravity-Gravity", "Dough-Dough", "Shadow-Shadow",
        "Venom-Venom", "Control-Control", "Spirit-Spirit", "Dragon-Dragon", "Leopard-Leopard"
    }

    for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
        if table.find(fruitNames, v.Name) then
            game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("StoreFruit", v.Name)
        end
    end
end

-- Phần 26: Toggle Auto Store Fruit
getgenv().AutoStoreFruit = false
local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0, 200, 0, 50)
btn.Position = UDim2.new(0.5, -100, 0.65, 0)
btn.Text = "Auto Store Fruit: OFF"
btn.Parent = game.CoreGui
btn.MouseButton1Click:Connect(function()
    getgenv().AutoStoreFruit = not getgenv().AutoStoreFruit
    btn.Text = getgenv().AutoStoreFruit and "Auto Store Fruit: ON" or "Auto Store Fruit: OFF"
    if getgenv().AutoStoreFruit then
        AutoStoreFruit()
    end
end)

-- Phần 27: Auto Equip Melee or Sword (recheck)
function AutoEquipPreferred(type)
    local meleeList = {
        "Combat", "Black Leg", "Electro", "Fishman Karate", "Dragon Claw", "Superhuman",
        "Sharkman Karate", "Electric Claw", "Death Step", "Dragon Breath", "Godhuman"
    }

    local swordList = {
        "Dark Blade", "Yama", "Tushita", "Hallow Scythe", "Cursed Dual Katana", "Shisui",
        "Wando", "Saddi", "Rengoku", "True Triple Katana", "Spikey Trident", "Buddy Sword",
        "Midnight Blade", "Canvander", "Pole", "Pole (2nd Form)"
    }

    local list = (type == "Melee") and meleeList or swordList

    for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
        if table.find(list, v.Name) then
            game.Players.LocalPlayer.Character.Humanoid:EquipTool(v)
            break
        end
    end
end)

-- Phần 28: GUI Dragging Mobile
function MakeDraggable(gui)
    local dragging, dragInput, dragStart, startPos

    gui.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = gui.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    gui.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseMovement) then
            local delta = input.Position - dragStart
            gui.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- Phần 29: Add Toggle for GUI visibility
local mainGui = Instance.new("ScreenGui", game.CoreGui)
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0, 60, 0, 60)
toggleBtn.Position = UDim2.new(0, 5, 0, 5)
toggleBtn.Text = "≡"
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
toggleBtn.TextScaled = true
toggleBtn.Parent = mainGui

local guiVisible = true
toggleBtn.MouseButton1Click:Connect(function()
    guiVisible = not guiVisible
    for _, v in pairs(mainGui:GetChildren()) do
        if v ~= toggleBtn then
            v.Visible = guiVisible
        end
    end
end)

-- Phần 30: Config Save/Load (Tùy chọn nâng cao – đơn giản)
function SaveConfig()
    local HttpService = game:GetService("HttpService")
    writefile("bf_auto_config.json", HttpService:JSONEncode({
        AutoFarm = getgenv().AutoFarm,
        AutoCollectFruit = getgenv().AutoCollectFruit,
        AutoStoreFruit = getgenv().AutoStoreFruit
    }))
end

function LoadConfig()
    local HttpService = game:GetService("HttpService")
    if isfile("bf_auto_config.json") then
        local data = HttpService:JSONDecode(readfile("bf_auto_config.json"))
        getgenv().AutoFarm = data.AutoFarm
        getgenv().AutoCollectFruit = data.AutoCollectFruit
        getgenv().AutoStoreFruit = data.AutoStoreFruit
    end
end
-- Phần 36: TweenTo Function (Dùng cho teleport mượt)
function TweenTo(cf)
    local ts = game:GetService("TweenService")
    local lp = game.Players.LocalPlayer
    if not lp.Character or not lp.Character:FindFirstChild("HumanoidRootPart") then return end

    local hrp = lp.Character.HumanoidRootPart
    local dist = (hrp.Position - cf.Position).Magnitude
    local tweenInfo = TweenInfo.new(dist / 300, Enum.EasingStyle.Linear)

    local goal = {CFrame = cf}
    local tween = ts:Create(hrp, tweenInfo, goal)
    tween:Play()
    tween.Completed:Wait()
end

-- Phần 37: WaitForChildOfClass Function (đảm bảo tìm thấy object đúng loại)
function WaitForChildOfClass(parent, class)
    for _, child in ipairs(parent:GetChildren()) do
        if child:IsA(class) then return child end
    end
    return parent.ChildAdded:Wait()
end

-- Phần 38: Clear ESPs
function ClearESP()
    for _, v in pairs(workspace:GetDescendants()) do
        if v:IsA("BillboardGui") and v.Name == "ESP" then
            v:Destroy()
        end
    end
end

-- Phần 39: Create UI Tab Button
function CreateTabButton(name, parent, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 120, 0, 30)
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    btn.TextColor3 = Color3.fromRGB(0, 255, 0)
    btn.Parent = parent
    btn.MouseButton1Click:Connect(callback)
end

-- Phần 40: Dynamic Weapon Dropdown Selector
function CreateWeaponDropdown(parent, weapons, callback)
    local dropdown = Instance.new("Frame", parent)
    dropdown.Size = UDim2.new(0, 180, 0, 100)
    dropdown.BackgroundColor3 = Color3.fromRGB(50, 50, 50)

    for i, weapon in ipairs(weapons) do
        local btn = Instance.new("TextButton", dropdown)
        btn.Size = UDim2.new(1, 0, 0, 20)
        btn.Position = UDim2.new(0, 0, 0, (i - 1) * 20)
        btn.Text = weapon
        btn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.MouseButton1Click:Connect(function()
            callback(weapon)
        end)
    end
end

-- Phần 41: Auto Quest Function
function AutoQuest(questName, mobName)
    local args = {
        [1] = "StartQuest",
        [2] = questName,
        [3] = 1
    }

    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))

    repeat wait()
        local quest = game.Players.LocalPlayer.PlayerGui:FindFirstChild("QuestBoard", true)
    until game.Players.LocalPlayer.PlayerGui:FindFirstChild("QuestBoard", true)
end

-- Phần 42: Mob Finder (get mob nearest)
function GetClosestMob(mobName)
    local closest, distance = nil, math.huge
    for _, mob in pairs(workspace.Enemies:GetChildren()) do
        if mob:FindFirstChild("HumanoidRootPart") and mob.Name == mobName and mob.Humanoid.Health > 0 then
            local dist = (game.Players.LocalPlayer.Character.HumanoidRootPart.Position - mob.HumanoidRootPart.Position).Magnitude
            if dist < distance then
                closest = mob
                distance = dist
            end
        end
    end
    return closest
end

-- Phần 43: Auto Farm Handler
function AutoFarmHandler()
    spawn(function()
        while getgenv().AutoFarm do
            local myLevel = game.Players.LocalPlayer.Data.Level.Value
            for _, v in pairs(LevelToMob) do
                if myLevel >= v.LevelReq then
                    local mob = GetClosestMob(v.Mob)
                    if not mob then
                        TweenTo(IslandPositions[v.Mob])
                        wait(3)
                        AutoQuest(v.Quest, v.Mob)
                    else
                        if not game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool") then
                            AutoEquipPreferred("Sword")
                        end
                        repeat
                            TweenTo(mob.HumanoidRootPart.CFrame * CFrame.new(0, 15, 0))
                            mob.HumanoidRootPart.Anchored = true
                            mouse1click()
                            wait()
                        until mob.Humanoid.Health <= 0 or not getgenv().AutoFarm
                    end
                end
            end
            wait()
        end
    end)
end

-- Phần 44: Setup AutoFarm Toggle
local afBtn = Instance.new("TextButton")
afBtn.Size = UDim2.new(0, 200, 0, 40)
afBtn.Position = UDim2.new(0, 100, 0, 300)
afBtn.Text = "Auto Farm: OFF"
afBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
afBtn.Parent = game.CoreGui
afBtn.MouseButton1Click:Connect(function()
    getgenv().AutoFarm = not getgenv().AutoFarm
    afBtn.Text = getgenv().AutoFarm and "Auto Farm: ON" or "Auto Farm: OFF"
    if getgenv().AutoFarm then
        AutoFarmHandler()
    end
end)

-- Phần 45: Click True (Fake Mouse Click)
function mouse1click()
    local VirtualInputManager = game:GetService("VirtualInputManager")
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
    task.wait()
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
end
-- Phần 46: Auto Equip Preferred Weapon
function AutoEquipPreferred(prefer)
	local Backpack = game.Players.LocalPlayer.Backpack
	local Char = game.Players.LocalPlayer.Character
	for _, tool in pairs(Backpack:GetChildren()) do
		if prefer == "Sword" and table.find(SwordList, tool.Name) then
			game.Players.LocalPlayer.Character.Humanoid:EquipTool(tool)
			return
		elseif prefer == "Melee" and table.find(MeleeList, tool.Name) then
			game.Players.LocalPlayer.Character.Humanoid:EquipTool(tool)
			return
		end
	end
	for _, tool in pairs(Char:GetChildren()) do
		if tool:IsA("Tool") and ((prefer == "Sword" and table.find(SwordList, tool.Name)) or (prefer == "Melee" and table.find(MeleeList, tool.Name))) then
			return
		end
	end
end

-- Phần 47: Danh sách Melee
MeleeList = {
	"Combat", "Black Leg", "Electro", "Fishman Karate", "Dragon Breath", "Superhuman",
	"Electric Claw", "Death Step", "Sharkman Karate", "Dragon Talon", "Godhuman"
}

-- Phần 48: Danh sách Sword
SwordList = {
	"Katana", "Cutlass", "Iron Mace", "Dual Katana", "Triple Katana",
	"Pipe", "Dual-Headed Blade", "Bisento", "Shark Blade", "Soul Cane", "Trident",
	"Pole", "Gravity Cane", "Longsword", "Saber", "Midnight Blade", "Dark Dagger",
	"Rengoku", "Yama", "Tushita", "Canvander", "Buddy Sword", "Spikey Trident", "Hallow Scythe"
}

-- Phần 49: ESP Setup (basic)
function CreateESP(name, color)
	for _, v in pairs(workspace:GetDescendants()) do
		if v:IsA("Model") and v:FindFirstChild("HumanoidRootPart") and v.Name == name then
			local esp = Instance.new("BillboardGui", v)
			esp.Name = "ESP"
			esp.Size = UDim2.new(0, 100, 0, 40)
			esp.Adornee = v:FindFirstChild("HumanoidRootPart")
			esp.AlwaysOnTop = true

			local txt = Instance.new("TextLabel", esp)
			txt.Size = UDim2.new(1, 0, 1, 0)
			txt.Text = name
			txt.TextColor3 = color
			txt.BackgroundTransparency = 1
			txt.Font = Enum.Font.GothamBold
			txt.TextScaled = true
		end
	end
end

-- Phần 50: Toggle ESP for Fruit
function ToggleFruitESP()
	local fruits = workspace:GetChildren()
	for _, obj in pairs(fruits) do
		if obj:IsA("Tool") and obj:FindFirstChild("Handle") and obj.Handle:FindFirstChildOfClass("MeshPart") then
			local esp = Instance.new("BillboardGui", obj)
			esp.Name = "ESP"
			esp.Size = UDim2.new(0, 100, 0, 40)
			esp.Adornee = obj.Handle
			esp.AlwaysOnTop = true

			local txt = Instance.new("TextLabel", esp)
			txt.Size = UDim2.new(1, 0, 1, 0)
			txt.Text = "🍉 " .. obj.Name
			txt.TextColor3 = Color3.fromRGB(255, 0, 0)
			txt.BackgroundTransparency = 1
			txt.Font = Enum.Font.GothamBold
			txt.TextScaled = true
		end
	end
end
-- Phần 51: Toggle ESP for Player
function TogglePlayerESP()
	for _, plr in pairs(game.Players:GetPlayers()) do
		if plr ~= game.Players.LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			if not plr.Character:FindFirstChild("PlayerESP") then
				local esp = Instance.new("BillboardGui", plr.Character)
				esp.Name = "PlayerESP"
				esp.Size = UDim2.new(0, 100, 0, 40)
				esp.Adornee = plr.Character.HumanoidRootPart
				esp.AlwaysOnTop = true

				local txt = Instance.new("TextLabel", esp)
				txt.Size = UDim2.new(1, 0, 1, 0)
				txt.Text = "🧍 " .. plr.Name
				txt.TextColor3 = Color3.fromRGB(0, 255, 0)
				txt.BackgroundTransparency = 1
				txt.Font = Enum.Font.GothamBold
				txt.TextScaled = true
			end
		end
	end
end

-- Phần 52: ESP Toggle Flags
getgenv().ESP_Player = false
getgenv().ESP_Fruit = false

-- Phần 53: ESP Loop
spawn(function()
	while task.wait(2) do
		if getgenv().ESP_Player then
			TogglePlayerESP()
		end
		if getgenv().ESP_Fruit then
			ToggleFruitESP()
		end
	end
end)

-- Phần 54: Auto Store Fruit
function AutoStoreFruit()
	local Backpack = game.Players.LocalPlayer.Backpack
	for _, item in pairs(Backpack:GetChildren()) do
		if item:IsA("Tool") and table.find(FruitNames, item.Name) then
			game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("StoreFruit", item.Name)
		end
	end
end

-- Phần 55: Fruit Stock Viewer
function OpenFruitStock(mirage)
	if mirage then
		game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("MirageIslandStock")
	else
		game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("GetFruits")
	end
end

-- Phần 56: Fruit Names Table
FruitNames = {
	"Bomb-Bomb", "Spike-Spike", "Chop-Chop", "Spring-Spring", "Kilo-Kilo", "Spin-Spin", 
	"Flame-Flame", "Bird-Bird: Falcon", "Ice-Ice", "Sand-Sand", "Dark-Dark", "Revive-Revive", 
	"Diamond-Diamond", "Light-Light", "Love-Love", "Rubber-Rubber", "Barrier-Barrier", 
	"Magma-Magma", "Quake-Quake", "Human-Human: Buddha", "String-String", "Phoenix-Phoenix", 
	"Rumble-Rumble", "Paw-Paw", "Gravity-Gravity", "Dough-Dough", "Shadow-Shadow", 
	"Venom-Venom", "Control-Control", "Spirit-Spirit", "Dragon-Dragon", "Leopard-Leopard"
}

-- Phần 57: Detect Nearby Fruit (auto collect)
function AutoCollectFruit()
	for _, obj in pairs(workspace:GetDescendants()) do
		if obj:IsA("Tool") and table.find(FruitNames, obj.Name) then
			firetouchinterest(game.Players.LocalPlayer.Character.HumanoidRootPart, obj.Handle, 0)
			wait()
			firetouchinterest(game.Players.LocalPlayer.Character.HumanoidRootPart, obj.Handle, 1)
		end
	end
end

-- Phần 58: Auto Collect Toggle
getgenv().AutoCollectFruit = true
spawn(function()
	while task.wait(3) do
		if getgenv().AutoCollectFruit then
			AutoCollectFruit()
		end
	end
end)

-- Phần 59: Create Tween Button Chooser
function CreateIslandDropdown(parent, options, callback)
	local dropdown = Instance.new("TextButton", parent)
	dropdown.Size = UDim2.new(1, -30, 0, 30)
	dropdown.Position = UDim2.new(0, 15, 0, 400)
	dropdown.Text = "🌴 Chọn Đảo"
	dropdown.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	dropdown.TextColor3 = Color3.new(1, 1, 1)
	dropdown.Font = Enum.Font.GothamBold
	dropdown.TextSize = 14
	Instance.new("UICorner", dropdown).CornerRadius = UDim.new(0, 6)

	dropdown.MouseButton1Click:Connect(function()
		local menu = Instance.new("Frame", parent)
		menu.Size = UDim2.new(0, 200, 0, 200)
		menu.Position = UDim2.new(0, 15, 0, 440)
		menu.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
		menu.ZIndex = 5
		menu.ClipsDescendants = true

		local UIList = Instance.new("UIListLayout", menu)
		UIList.SortOrder = Enum.SortOrder.LayoutOrder

		for _, island in pairs(options) do
			local btn = Instance.new("TextButton", menu)
			btn.Size = UDim2.new(1, 0, 0, 30)
			btn.Text = island
			btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
			btn.TextColor3 = Color3.new(1, 1, 1)
			btn.Font = Enum.Font.Gotham
			btn.TextSize = 12
			btn.MouseButton1Click:Connect(function()
				callback(island)
				menu:Destroy()
			end)
		end
	end)
end

-- Phần 60: Gọi dropdown chọn đảo
local islandList = {}
for name, _ in pairs(IslandPositions) do
	table.insert(islandList, name)
end

CreateIslandDropdown(gui, islandList, function(selectedIsland)
	TweenToIsland(IslandPositions[selectedIsland])
end)
-- Phần 61: TweenToIsland function
function TweenToIsland(targetCFrame)
	if not targetCFrame then return end
	local hrp = game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local distance = (hrp.Position - targetCFrame.Position).Magnitude
	local time = distance / 300 -- Tween speed
	local tweenInfo = TweenInfo.new(time, Enum.EasingStyle.Linear)
	local tween = game:GetService("TweenService"):Create(hrp, tweenInfo, {CFrame = targetCFrame + Vector3.new(0, 100, 0)})
	tween:Play()
	tween.Completed:Wait()
end

-- Phần 62: Auto Farm Controller
getgenv().AutoFarm = false
getgenv().SelectedMob = nil

-- Phần 63: GetMobCFrame Function
function GetClosestMobCFrame(mobName)
	local mobs = {}
	for _, v in pairs(workspace.Enemies:GetChildren()) do
		if v.Name == mobName and v:FindFirstChild("HumanoidRootPart") and v.Humanoid.Health > 0 then
			table.insert(mobs, v)
		end
	end
	table.sort(mobs, function(a, b)
		local distA = (a.HumanoidRootPart.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
		local distB = (b.HumanoidRootPart.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
		return distA < distB
	end)
	if #mobs > 0 then
		return mobs[1].HumanoidRootPart.CFrame + Vector3.new(0, 8, 0)
	end
	return nil
end

-- Phần 64: Auto Quest Function
function AutoQuest(mobData)
	local args = {
		[1] = "StartQuest",
		[2] = mobData.Quest,
		[3] = 1
	}
	game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
end

-- Phần 65: Check Has Quest
function HasQuest()
	return game:GetService("Players").LocalPlayer.PlayerGui:FindFirstChild("Main") and
		   game:GetService("Players").LocalPlayer.PlayerGui.Main:FindFirstChild("Quest")
end

-- Phần 66: Hitbox Expand
function ExpandHitbox()
	for _, mob in pairs(workspace.Enemies:GetChildren()) do
		if mob:IsA("Model") and mob:FindFirstChild("HumanoidRootPart") then
			mob.HumanoidRootPart.Size = Vector3.new(50, 50, 50)
			mob.HumanoidRootPart.Transparency = 1
			mob.HumanoidRootPart.CanCollide = false
		end
	end
end

-- Phần 67: Create Floating Platform
function CreatePlatform()
	local part = Instance.new("Part", workspace)
	part.Size = Vector3.new(50, 1, 50)
	part.Anchored = true
	part.Position = game.Players.LocalPlayer.Character.HumanoidRootPart.Position - Vector3.new(0, 4, 0)
	part.Transparency = 1
	part.Name = "FarmPlatform"
	return part
end

-- Phần 68: Destroy Platform
function DestroyPlatform()
	for _, p in pairs(workspace:GetChildren()) do
		if p:IsA("Part") and p.Name == "FarmPlatform" then
			p:Destroy()
		end
	end
end

-- Phần 69: Auto Equip Weapon
function AutoEquip()
	local toolName = nil
	local backpack = game.Players.LocalPlayer.Backpack
	local char = game.Players.LocalPlayer.Character
	for _, tool in pairs(backpack:GetChildren()) do
		if table.find(MeleeList, tool.Name) and getgenv().UseMelee then
			toolName = tool.Name
			break
		elseif table.find(SwordList, tool.Name) and not getgenv().UseMelee then
			toolName = tool.Name
			break
		end
	end
	if toolName then
		game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("EquipItem", toolName)
	end
end

-- Phần 70: Auto Attack Function
function AutoClick()
	local vim = game:GetService("VirtualInputManager")
	vim:SendMouseButtonEvent(0, 0, 0, true, game, 0)
	task.wait()
	vim:SendMouseButtonEvent(0, 0, 0, false, game, 0)
end

-- Phần 71: Main Auto Farm Loop
spawn(function()
	while task.wait(0.1) do
		if getgenv().AutoFarm and getgenv().SelectedMob then
			local mobData = LevelToMob[getgenv().SelectedMob]
			if not mobData then continue end

			-- Check and go to island
			local islandCFrame = IslandPositions[mobData.Mob]
			if islandCFrame then
				TweenToIsland(islandCFrame)
				wait(3)
			end

			-- Auto quest
			if not HasQuest() then
				AutoQuest(mobData)
				wait(2)
			end

			-- Expand Hitbox & Platform
			ExpandHitbox()
			local platform = CreatePlatform()

			-- Find mob & attack
			local mobCFrame = GetClosestMobCFrame(mobData.Mob)
			if mobCFrame then
				TweenToIsland(mobCFrame)
				AutoEquip()
				repeat
					AutoClick()
					task.wait(0.2)
				until not mobCFrame or not getgenv().AutoFarm
			end

			DestroyPlatform()
		end
	end
end)

-- Phần 72: Update Weapon Toggle GUI
weaponBtn.MouseButton1Click:Connect(function()
	getgenv().UseMelee = not getgenv().UseMelee
	weaponBtn.Text = getgenv().UseMelee and "Weapon: 🥋 Melee" or "Weapon: ⚔️ Sword"
end)

-- Phần 73: Update AutoFarm Toggle GUI
autoFarmBtn.MouseButton1Click:Connect(function()
	getgenv().AutoFarm = not getgenv().AutoFarm
	autoFarmBtn.Text = getgenv().AutoFarm and "Auto Farm: ON ✅" or "Auto Farm: OFF ❌"
end)

-- Phần 74: Update Tabs Visibility
function SetTab(tab)
	for name, frame in pairs(TabFrames) do
		frame.Visible = (name == tab)
	end
end

-- Phần 75: Tab Switch Buttons
for tabName, _ in pairs(TabFrames) do
	local tabBtn = createButton(tabName, btnY, function()
		SetTab(tabName)
	end)
	btnY += 45
end

-- Phần 76: Add ESP for Island
function ESP_Islands()
	for name, cframe in pairs(IslandPositions) do
		local part = Instance.new("Part", workspace)
		part.Anchored = true
		part.CanCollide = false
		part.Size = Vector3.new(1,1,1)
		part.Position = cframe.Position
		part.Transparency = 1

		local esp = Instance.new("BillboardGui", part)
		esp.Size = UDim2.new(0, 100, 0, 40)
		esp.Adornee = part
		esp.AlwaysOnTop = true

		local txt = Instance.new("TextLabel", esp)
		txt.Size = UDim2.new(1, 0, 1, 0)
		txt.Text = "🏝️ " .. name
		txt.TextColor3 = Color3.fromRGB(0, 255, 255)
		txt.BackgroundTransparency = 1
		txt.Font = Enum.Font.GothamBold
		txt.TextScaled = true
	end
end

-- Phần 77: Toggle ESP Island
getgenv().ESP_Island = true
spawn(function()
	while wait(3) do
		if getgenv().ESP_Island then
			ESP_Islands()
		end
	end
end)

-- Phần 78: GUI Lock Position
gui.IgnoreGuiInset = true
gui.DisplayOrder = 1000
gui.ResetOnSpawn = false

-- Phần 79: Tween Function Fix (if error)
function SafeTween(cframe)
	local success, err = pcall(function()
		TweenToIsland(cframe)
	end)
	if not success then
		warn("Tween Error:", err)
	end
end

-- Phần 80: Anti-AFK (again)
for i,v in pairs(getconnections(game.Players.LocalPlayer.Idled)) do
	v:Disable()
end
-- Phần 81-100: ESP Trái Ác Quỷ, Auto Collect Fruit, Fruit Stock
local fruitESPEnabled = false
local function toggleFruitESP()
    fruitESPEnabled = not fruitESPEnabled
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Tool") and v:FindFirstChild("Handle") then
            if fruitESPEnabled then
                if not v:FindFirstChild("FruitESP") then
                    local esp = Instance.new("BillboardGui", v)
                    esp.Name = "FruitESP"
                    esp.Size = UDim2.new(0, 100, 0, 40)
                    esp.AlwaysOnTop = true
                    esp.StudsOffset = Vector3.new(0, 2, 0)

                    local text = Instance.new("TextLabel", esp)
                    text.Size = UDim2.new(1, 0, 1, 0)
                    text.BackgroundTransparency = 1
                    text.Text = v.Name .. " 🍌"
                    text.TextColor3 = Color3.fromRGB(255, 0, 0)
                    text.TextStrokeTransparency = 0
                    text.TextScaled = true
                    text.Font = Enum.Font.GothamBold
                end
            else
                if v:FindFirstChild("FruitESP") then
                    v.FruitESP:Destroy()
                end
            end
        end
    end
end

-- Auto collect fruit
local function autoCollectFruit()
    while getgenv().AutoFruit do
        for _, v in pairs(game.Workspace:GetDescendants()) do
            if v:IsA("Tool") and v:FindFirstChild("Handle") and v:FindFirstChild("TouchInterest") then
                firetouchinterest(game.Players.LocalPlayer.Character.HumanoidRootPart, v.Handle, 0)
                wait(0.1)
                firetouchinterest(game.Players.LocalPlayer.Character.HumanoidRootPart, v.Handle, 1)
            end
        end
        wait(3)
    end
end

-- Toggle auto fruit
getgenv().AutoFruit = false
local function toggleAutoFruit()
    getgenv().AutoFruit = not getgenv().AutoFruit
    if getgenv().AutoFruit then
        task.spawn(autoCollectFruit)
    end
end

-- Fruit Stock từ xa (bao gồm Mirage)
local function openFruitStock()
    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("GetFruits")
end
