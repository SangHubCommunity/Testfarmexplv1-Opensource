repeat task.wait() until game:IsLoaded()
if game.CoreGui:FindFirstChild("BFAuto") then game.CoreGui.BFAuto:Destroy() end

local plr = game.Players.LocalPlayer
local rs = game:GetService("RunService")
local ts = game:GetService("TweenService")
local vim = game:GetService("VirtualInputManager")
local rep = game:GetService("ReplicatedStorage")

-- GUI TOGGLE
local mainGui = Instance.new("ScreenGui", game.CoreGui)
mainGui.Name = "BFAuto"

local toggleBtn = Instance.new("TextButton", mainGui)
toggleBtn.Size = UDim2.new(0, 100, 0, 30)
toggleBtn.Position = UDim2.new(0, 10, 0.85, 0)
toggleBtn.Text = "Toggle GUI"
toggleBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 14
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 8)

local gui = Instance.new("Frame", mainGui)
gui.Size = UDim2.new(0, 220, 0, 220)
gui.Position = UDim2.new(0.05, 0, 0.2, 0)
gui.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
gui.BorderSizePixel = 0
gui.Active = true
gui.Draggable = true
Instance.new("UICorner", gui).CornerRadius = UDim.new(0, 10)

toggleBtn.MouseButton1Click:Connect(function()
    gui.Visible = not gui.Visible
end)

-- UI Buttons
local function CreateButton(text, posY)
	local btn = Instance.new("TextButton", gui)
	btn.Size = UDim2.new(1, -20, 0, 30)
	btn.Position = UDim2.new(0, 10, 0, posY)
	btn.Text = text
	btn.BackgroundColor3 = Color3.fromRGB(50, 120, 200)
	btn.TextColor3 = Color3.new(1, 1, 1)
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 14
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
	return btn
end

local btnFarm = CreateButton("Auto Farm: OFF", 10)
local btnESP = CreateButton("ESP Người Chơi: OFF", 50)
local btnFruitESP = CreateButton("ESP Trái: OFF", 90)
local btnCollect = CreateButton("Auto Collect Trái: OFF", 130)

local autoFarm, espOn, fruitESPOn, autoCollect = false, false, false, false

btnFarm.MouseButton1Click:Connect(function()
	autoFarm = not autoFarm
	btnFarm.Text = autoFarm and "Auto Farm: ON" or "Auto Farm: OFF"
end)

btnESP.MouseButton1Click:Connect(function()
	espOn = not espOn
	btnESP.Text = espOn and "ESP Người Chơi: ON" or "ESP Người Chơi: OFF"
end)

btnFruitESP.MouseButton1Click:Connect(function()
	fruitESPOn = not fruitESPOn
	btnFruitESP.Text = fruitESPOn and "ESP Trái: ON" or "ESP Trái: OFF"
end)

btnCollect.MouseButton1Click:Connect(function()
	autoCollect = not autoCollect
	btnCollect.Text = autoCollect and "Auto Collect Trái: ON" or "Auto Collect Trái: OFF"
end)

-- Auto Click
task.spawn(function()
	while task.wait(0.15) do
		if autoFarm then
			vim:SendMouseButtonEvent(0, 0, 0, true, game, 0)
			task.wait()
			vim:SendMouseButtonEvent(0, 0, 0, false, game, 0)
		end
	end
end)

-- Auto Haki
task.spawn(function()
	while true do
		task.wait(5)
		rep.Remotes.CommE:FireServer("Buso")
	end
end)

-- ESP & Auto Collect
local function CreateESP(part, name, color, tagName)
	local tag = Instance.new("BillboardGui", part)
	tag.Name = tagName
	tag.Size = UDim2.new(0, 100, 0, 40)
	tag.StudsOffset = Vector3.new(0, 2, 0)
	tag.AlwaysOnTop = true

	local txt = Instance.new("TextLabel", tag)
	txt.Size = UDim2.new(1, 0, 1, 0)
	txt.Text = name
	txt.TextColor3 = color
	txt.TextSize = 10
	txt.BackgroundTransparency = 1
end

task.spawn(function()
	while task.wait(1) do
		for _,pl in pairs(game.Players:GetPlayers()) do
			if pl ~= plr and pl.Character and pl.Character:FindFirstChild("Head") then
				local head = pl.Character.Head
				if espOn and not head:FindFirstChild("ESP") then
					CreateESP(head, pl.Name, Color3.fromRGB(0,255,0), "ESP")
				elseif not espOn and head:FindFirstChild("ESP") then
					head:FindFirstChild("ESP"):Destroy()
				end
			end
		end

		for _,v in pairs(workspace:GetChildren()) do
			if v:IsA("Tool") and v:FindFirstChild("Handle") and v.Handle:FindFirstChild("TouchInterest") then
				if fruitESPOn and not v:FindFirstChild("FruitESP") then
					CreateESP(v, v.Name, Color3.fromRGB(255,0,0), "FruitESP")
				elseif not fruitESPOn and v:FindFirstChild("FruitESP") then
					v.FruitESP:Destroy()
				end
				if autoCollect and (v.Position - plr.Character.HumanoidRootPart.Position).Magnitude < 50 then
					firetouchinterest(plr.Character.HumanoidRootPart, v.Handle, 0)
					firetouchinterest(plr.Character.HumanoidRootPart, v.Handle, 1)
				end
			end
		end
	end
end)
-- Tạo block ảo dưới chân để không rớt khi bay
local function CreateFootPlat()
	local plat = workspace:FindFirstChild("BFPlat") or Instance.new("Part", workspace)
	plat.Name = "BFPlat"
	plat.Anchored = true
	plat.CanCollide = true
	plat.Transparency = 1
	plat.Size = Vector3.new(10, 1, 10)
	plat.Position = plr.Character.HumanoidRootPart.Position - Vector3.new(0, 3, 0)
end

-- Tween mượt có block dính dưới chân
local function SmoothTween(pos)
	local hrp = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	CreateFootPlat()
	local t = ts:Create(hrp, TweenInfo.new((hrp.Position - pos).Magnitude / 300, Enum.EasingStyle.Linear), {CFrame = CFrame.new(pos)})
	t:Play()
	t.Completed:Wait()
end

-- Danh sách quest SEA 1
getgenv().BF_LevelFarm = {
	[1] = {Quest="BanditQuest1",Mob="Bandit",Pos=Vector3.new(1059,17,1547),QuestPos=Vector3.new(1060,17,1545)},
	[10] = {Quest="JungleQuest",Mob="Monkey",Pos=Vector3.new(-1602,36,153),QuestPos=Vector3.new(-1602,36,155)},
	[15] = {Quest="JungleQuest",Mob="Gorilla",Pos=Vector3.new(-1237,6,-507),QuestPos=Vector3.new(-1602,36,155)},
	[30] = {Quest="BuggyQuest1",Mob="Pirate",Pos=Vector3.new(-1145,14,3828),QuestPos=Vector3.new(-1144,14,3828)},
	[40] = {Quest="BuggyQuest1",Mob="Brute",Pos=Vector3.new(-1322,15,4294),QuestPos=Vector3.new(-1144,14,3828)},
	[60] = {Quest="BuggyQuest2",Mob="Desert Bandit",Pos=Vector3.new(932,7,4486),QuestPos=Vector3.new(896,7,4373)},
	[75] = {Quest="BuggyQuest2",Mob="Desert Officer",Pos=Vector3.new(1572,10,4373),QuestPos=Vector3.new(896,7,4373)},
	[90] = {Quest="SnowQuest",Mob="Snow Bandit",Pos=Vector3.new(1289,87,-1412),QuestPos=Vector3.new(1386,87,-1297)},
	[105] = {Quest="SnowQuest",Mob="Snowman",Pos=Vector3.new(1231,87,-1510),QuestPos=Vector3.new(1386,87,-1297)},
	-- Bạn có thể tự thêm thêm các đảo còn lại nếu cần
}

-- Get quest phù hợp
local function GetTarget()
	local lvl = plr.Data.Level.Value
	local last
	for l, v in pairs(getgenv().BF_LevelFarm) do
		if lvl >= l then last = v end
	end
	return last
end

-- Hàm chỉnh hitbox mob
local function ResizeMob(mob)
	for _,v in ipairs(mob:GetChildren()) do
		if v:IsA("BasePart") then
			v.Size = Vector3.new(60,60,60)
			v.Transparency = 0.2
			v.CanCollide = false
		end
	end
end

-- Farm loop
task.spawn(function()
	local currentTarget = nil
	while task.wait() do
		if autoFarm then
			local data = GetTarget()
			if not data then continue end

			local char = plr.Character
			local hrp = char:WaitForChild("HumanoidRootPart")

			-- Nếu không có quest thì mới đến nhận
			local hasQuest = plr.PlayerGui:FindFirstChild("Main") and plr.PlayerGui.Main:FindFirstChild("Quest") and plr.PlayerGui.Main.Quest.Visible
			if not hasQuest then
				SmoothTween(data.QuestPos)
				task.wait(0.3)
				rep.Remotes.CommF_:InvokeServer("StartQuest", data.Quest, 1)
				task.wait(0.5)
			end

			-- Farm quái
			for _,mob in pairs(workspace.Enemies:GetChildren()) do
				if mob.Name == data.Mob and mob:FindFirstChild("HumanoidRootPart") and mob.Humanoid.Health > 0 then
					ResizeMob(mob)

					local root = mob.HumanoidRootPart
					local high = root.Position + Vector3.new(0, 10, 0)

					local anchor = Instance.new("Part", root)
					anchor.Anchored = true
					anchor.Transparency = 1
					anchor.CanCollide = true
					anchor.Size = Vector3.new(8,1,8)
					anchor.Position = high

					-- Giữ quái đứng yên
					mob.HumanoidRootPart.Anchored = true

					repeat
						SmoothTween(high + Vector3.new(0, 2, 0))
						CreateFootPlat()
						task.wait(0.1)
					until not autoFarm or not mob or mob.Humanoid.Health <= 0

					mob.HumanoidRootPart.Anchored = false
					break -- Dừng ở 1 con, không chuyển sang con khác
				end
			end
		else
			if workspace:FindFirstChild("BFPlat") then workspace.BFPlat:Destroy() end
		end
	end
end)
-- Danh sách tên vũ khí
local meleeList = {"Combat","Black Leg","Electro","Fishman Karate","Superhuman","Death Step","Sharkman Karate","Electric Claw","Dragon Talon","Godhuman"}
local swordList = {"Katana","Cutlass","Iron Mace","Triple Katana","Pipe","Dual Katana","Shisui","Yama","Saber","Dark Blade","Rengoku","Buddy Sword","Cursed Dual Katana"}

-- Lựa chọn
local useMelee = true -- true: Melee | false: Sword

-- Toggle đổi vũ khí
local btnMode = CreateButton("Vũ khí: Melee", 170)
btnMode.MouseButton1Click:Connect(function()
	useMelee = not useMelee
	btnMode.Text = useMelee and "Vũ khí: Melee" or "Vũ khí: Sword"
end)

-- Auto equip đúng loại
local function AutoEquip()
	if plr.Character:FindFirstChildOfClass("Tool") then return end -- Không đổi nếu đã cầm

	local bp = plr.Backpack:GetChildren()
	for _,v in pairs(bp) do
		if useMelee and table.find(meleeList, v.Name) then
			plr.Character.Humanoid:EquipTool(v)
			break
		elseif not useMelee and table.find(swordList, v.Name) then
			plr.Character.Humanoid:EquipTool(v)
			break
		end
	end
end
-- Hàm tạo ESP
local function CreateESP(target, text, color, tag)
	local esp = Instance.new("BillboardGui", target)
	esp.Name = tag
	esp.Size = UDim2.new(0, 100, 0, 30)
	esp.AlwaysOnTop = true
	esp.StudsOffset = Vector3.new(0, 2, 0)

	local label = Instance.new("TextLabel", esp)
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = color
	label.TextSize = 10
	label.Font = Enum.Font.Gotham
end

-- Vòng lặp ESP
task.spawn(function()
	while true do
		task.wait(1)
		for _,v in pairs(game.Players:GetPlayers()) do
			if v ~= plr and v.Character and v.Character:FindFirstChild("Head") then
				local head = v.Character.Head
				if espOn and not head:FindFirstChild("PlayerESP") then
					CreateESP(head, v.Name, Color3.fromRGB(0,255,0), "PlayerESP")
				elseif not espOn and head:FindFirstChild("PlayerESP") then
					head.PlayerESP:Destroy()
				end
			end
		end

		for _,v in pairs(workspace:GetChildren()) do
			if v:IsA("Tool") and v:FindFirstChild("Handle") then
				if fruitESPOn and not v:FindFirstChild("FruitESP") then
					CreateESP(v, v.Name, Color3.fromRGB(255,0,0), "FruitESP")
				elseif not fruitESPOn and v:FindFirstChild("FruitESP") then
					v.FruitESP:Destroy()
				end

				-- Auto collect nếu bật
				if autoCollect and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
					local hrp = plr.Character.HumanoidRootPart
					if (v.Position - hrp.Position).Magnitude < 80 then
						firetouchinterest(hrp, v.Handle, 0)
						firetouchinterest(hrp, v.Handle, 1)
					end
				end
			end
		end
	end
end)
-- Auto Click thật bằng VirtualInputManager
task.spawn(function()
	while task.wait(0.15) do
		if autoFarm then
			vim:SendMouseButtonEvent(0, 0, 0, true, game, 0)
			task.wait()
			vim:SendMouseButtonEvent(0, 0, 0, false, game, 0)
		end
	end
end)
-- Auto bật Haki mỗi 5s (vĩnh viễn)
task.spawn(function()
	while true do
		task.wait(5)
		pcall(function()
			rep.Remotes.CommE:FireServer("Buso")
		end)
	end
end)
